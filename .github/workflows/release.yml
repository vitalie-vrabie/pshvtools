name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.9)'
        required: true

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install Inno Setup
      shell: pwsh
      run: |
        choco install innosetup -y
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Build GUI Application
      shell: pwsh
      run: |
        dotnet publish PSHVTools.GUI/PSHVToolsShell/PSHVToolsShell.csproj -c Release -r win-x64 -f net10.0-windows --self-contained false
        
    - name: Copy GUI Executable to Dist
      shell: pwsh
      run: |
        Copy-Item "PSHVTools.GUI/PSHVToolsShell/bin/Release/net10.0-windows/win-x64/publish/PSHVToolsShell.exe" "dist/"
        
    - name: Update Documentation and Samples
      shell: pwsh
      run: |
        # Update docs and samples before release
        # This step ensures documentation is current and samples are updated
        Write-Host "Updating documentation and samples..."
        # Add commands here to update docs, e.g., regenerate README, update samples, etc.
        # For now, this is a placeholder - implement specific update logic as needed
        
    - name: Rebuild Installer (if needed)
      shell: pwsh
      run: |
        # Rebuild installer to ensure it's up-to-date with latest changes
        Write-Host "Rebuilding installer..."
        ./build.ps1 -Verbose

    - name: Generate Checksums
      shell: pwsh
      run: |
        $hash = Get-FileHash "dist/PSHVTools-Setup.exe" -Algorithm SHA256
        "$($hash.Hash)  PSHVTools-Setup.exe" | Out-File "dist/PSHVTools-Setup.exe.sha256"
        
    - name: Read Release Notes
      id: release_notes
      shell: pwsh
      run: |
        $content = Get-Content RELEASE_NOTES.md -Raw
        # Escape content for GitHub output
        $content = $content -replace "`r`n", "%0A"
        Write-Host "notes=$content" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
        
    - name: Check if Stable Release
      id: check_stable
      shell: pwsh
      run: |
        $versionJson = Get-Content version.json | ConvertFrom-Json
        $stableVersion = $versionJson.stableVersion
        $tag = $env:GITHUB_REF_NAME -replace '^v', ''
        $isStable = $tag -eq $stableVersion
        Write-Host "is_stable=$isStable" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/PSHVTools-Setup.exe
          dist/PSHVTools-Setup.exe.sha256
          dist/PSHVToolsShell.exe
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: ${{ steps.check_stable.outputs.is_stable == 'False' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
