# Build-All-Installers.ps1
# Master build script for all PSVMTools installer types

[CmdletBinding()]
param(
    [Parameter(Mandatory = $false)]
    [switch]$SkipWix,
    
    [Parameter(Mandatory = $false)]
    [switch]$CleanFirst
)

$ErrorActionPreference = 'Stop'

# ASCII Art Banner
$banner = @"
?????????????????????????????????????????????????????????????????
?                                                               ?
?   ??????? ???????????   ???????   ????????????? ???????      ?
?   ???????????????????   ???????? ???????????????????????     ?
?   ???????????????????   ??????????????   ???   ???   ???     ?
?   ??????? ???????????? ???????????????   ???   ???   ???     ?
?   ???     ???????? ??????? ??? ??? ???   ???   ?????????     ?
?   ???     ????????  ?????  ???     ???   ???    ???????      ?
?                                                               ?
?              Master Installer Builder v1.0.0                 ?
?                                                               ?
?????????????????????????????????????????????????????????????????
"@

Write-Host $banner -ForegroundColor Cyan
Write-Host ""

$scriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
$distPath = Join-Path -Path $scriptDir -ChildPath "dist"

# Clean dist folder if requested
if ($CleanFirst -and (Test-Path $distPath)) {
    Write-Host "Cleaning dist folder..." -ForegroundColor Yellow
    Remove-Item -Path $distPath -Recurse -Force
    Write-Host "  [OK] Cleaned" -ForegroundColor Green
}

Write-Host "Starting build process..." -ForegroundColor Cyan
Write-Host ""

# Build 1: Self-Extracting PowerShell Installer
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host " Building Self-Extracting PowerShell Installer" -ForegroundColor Cyan
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

try {
    $buildScriptPath = Join-Path -Path $scriptDir -ChildPath "Build-PSVMTools-Installer.ps1"
    & $buildScriptPath -OutputPath $distPath
    Write-Host "  [OK] Self-extracting installer built successfully" -ForegroundColor Green
    Write-Host ""
} catch {
    Write-Host "  [ERROR] Failed to build self-extracting installer: $_" -ForegroundColor Red
    throw
}

# Build 2: WiX MSI Installer (if not skipped)
if (-not $SkipWix) {
    Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host " Building WiX MSI Installer" -ForegroundColor Cyan
    Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    
    # Check if WiX is installed
    $wixPath = $null
    $possiblePaths = @(
        "${env:ProgramFiles}\WiX Toolset v3.11\bin",
        "${env:ProgramFiles(x86)}\WiX Toolset v3.11\bin",
        "${env:WIX}bin"
    )
    
    foreach ($path in $possiblePaths) {
        if (Test-Path (Join-Path $path "candle.exe")) {
            $wixPath = $path
            break
        }
    }
    
    if (-not $wixPath) {
        # Try to find in PATH
        $candleCmd = Get-Command candle.exe -ErrorAction SilentlyContinue
        if ($candleCmd) {
            $wixPath = Split-Path -Parent $candleCmd.Path
        }
    }
    
    if ($wixPath) {
        Write-Host "Found WiX Toolset at: $wixPath" -ForegroundColor Yellow
        
        try {
            $wixBuildScript = Join-Path -Path $scriptDir -ChildPath "Build-WixInstaller.ps1"
            
            # Run WiX build
            & $wixBuildScript -OutputPath $distPath -SkipWixCheck
            
            if ($LASTEXITCODE -eq 0) {
                Write-Host "  [OK] WiX MSI installer built successfully" -ForegroundColor Green
                Write-Host ""
            } else {
                Write-Host "  [ERROR] WiX build failed with exit code: $LASTEXITCODE" -ForegroundColor Red
            }
        } catch {
            Write-Host "  [ERROR] Failed to build WiX installer: $_" -ForegroundColor Red
        }
    } else {
        Write-Host "  [SKIP] WiX Toolset not found. Skipping MSI installer." -ForegroundColor Yellow
        Write-Host "  To build MSI installer, install WiX Toolset from:" -ForegroundColor Yellow
        Write-Host "  https://wixtoolset.org/releases/" -ForegroundColor Yellow
        Write-Host "  Or use Chocolatey: choco install wixtoolset" -ForegroundColor Yellow
        Write-Host ""
    }
} else {
    Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Yellow
    Write-Host " Skipping WiX Installer (use -SkipWix:`$false to build)" -ForegroundColor Yellow
    Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Yellow
    Write-Host ""
}

# Create a release package (ZIP)
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host " Creating Release Package" -ForegroundColor Cyan
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Cyan
Write-Host ""

try {
    $zipPath = Join-Path -Path $distPath -ChildPath "PSVMTools-1.0.0-Complete.zip"
    
    # Files to include in ZIP
    $filesToZip = @(
        'vmbak.ps1',
        'vmbak.psm1',
        'vmbak.psd1',
        'Install-vmbak.ps1',
        'Uninstall-vmbak.ps1',
        'README_VMBAK_MODULE.md',
        'QUICKSTART.md',
        'PACKAGE_README.md',
        'LICENSE.txt'
    )
    
    # Add installer files from dist
    $installerFiles = @(
        'PSVMTools-Setup.ps1',
        'PSVMTools-Setup.bat',
        'PSVMTools-Uninstall.bat'
    )
    
    # Create temp directory for ZIP contents
    $tempZipDir = Join-Path -Path $env:TEMP -ChildPath "PSVMTools_Release_$(Get-Random)"
    New-Item -Path $tempZipDir -ItemType Directory -Force | Out-Null
    
    # Copy module files
    foreach ($file in $filesToZip) {
        $source = Join-Path -Path $scriptDir -ChildPath $file
        if (Test-Path $source) {
            Copy-Item -Path $source -Destination $tempZipDir -Force
        }
    }
    
    # Copy installer files
    $installerSubDir = Join-Path -Path $tempZipDir -ChildPath "installer"
    New-Item -Path $installerSubDir -ItemType Directory -Force | Out-Null
    
    foreach ($file in $installerFiles) {
        $source = Join-Path -Path $distPath -ChildPath $file
        if (Test-Path $source) {
            Copy-Item -Path $source -Destination $installerSubDir -Force
        }
    }
    
    # Create ZIP
    Compress-Archive -Path "$tempZipDir\*" -DestinationPath $zipPath -Force
    
    # Cleanup temp
    Remove-Item -Path $tempZipDir -Recurse -Force
    
    $zipSize = [Math]::Round((Get-Item $zipPath).Length / 1KB, 2)
    Write-Host "  [OK] Release package created: PSVMTools-1.0.0-Complete.zip ($zipSize KB)" -ForegroundColor Green
    Write-Host ""
} catch {
    Write-Host "  [ERROR] Failed to create release package: $_" -ForegroundColor Red
}

# Summary
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host " Build Summary" -ForegroundColor Green
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host ""
Write-Host "Output directory: $distPath" -ForegroundColor Cyan
Write-Host ""
Write-Host "Created files:" -ForegroundColor Cyan

$distFiles = Get-ChildItem -Path $distPath -File | Sort-Object Name
foreach ($file in $distFiles) {
    $size = [Math]::Round($file.Length / 1KB, 2)
    Write-Host "  ? $($file.Name) - $size KB" -ForegroundColor White
}

Write-Host ""
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host " Distribution Options" -ForegroundColor Green
Write-Host "???????????????????????????????????????????????????????????" -ForegroundColor Green
Write-Host ""
Write-Host "Option 1 - PowerShell Installer (No dependencies):" -ForegroundColor Cyan
Write-Host "  Distribute: PSVMTools-Setup.bat + PSVMTools-Setup.ps1" -ForegroundColor White
Write-Host ""
Write-Host "Option 2 - MSI Installer (Professional):" -ForegroundColor Cyan
if (Test-Path (Join-Path $distPath "PSVMTools-Setup-1.0.0.msi")) {
    Write-Host "  Distribute: PSVMTools-Setup-1.0.0.msi" -ForegroundColor White
} else {
    Write-Host "  Not built (WiX Toolset not available)" -ForegroundColor Yellow
}
Write-Host ""
Write-Host "Option 3 - Complete Package (All methods):" -ForegroundColor Cyan
Write-Host "  Distribute: PSVMTools-1.0.0-Complete.zip" -ForegroundColor White
Write-Host ""

Write-Host "Build completed successfully! ??" -ForegroundColor Green
Write-Host ""
